name: Deploy to Production (Hotfix + Delta Deploy + Auto Back-Sync)

on:
  push:
    branches:
      - main
    paths:
      - "force-app/**"
  workflow_dispatch:

env:
  SYNC_BRANCHES: ${{ vars.SYNC_BRANCHES || 'preprodbranch uatbranch feature/test-validation' }}

jobs:

  ###########################################################################
  # 1Ô∏è‚É£ DEPLOY DELTA TO PRODUCTION (with test logic)
  ###########################################################################
  deploy-production:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Install SFDX Git Delta
        run: echo y | sf plugins install sfdx-git-delta

      - name: Authenticate to Production
        run: |
          echo "${{ secrets.PROD_SFDX_AUTH_URL }}" > prod_auth.txt
          sf org login sfdx-url -f prod_auth.txt --alias prodorg --set-default

      ###################################################################
      # Generate Only Delta Package
      ###################################################################
      - name: Generate Delta Package
        id: delta
        run: |
          mkdir -p delta
          sf sgd:source:delta \
            --to HEAD \
            --from HEAD^ \
            --output-dir delta \
            --generate-delta \
            --source force-app/

          if [ ! -s delta/package/package.xml ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      ###################################################################
      # Deploy to PROD - RunSpecifiedTests (if variable != ALL)
      ###################################################################
      - name: Deploy Delta to PROD - RunSpecifiedTests
        if: steps.delta.outputs.skip == 'false' && vars.PROD_TEST_CLASSES != 'ALL'
        run: |
          echo "Running specific test classes: ${{ vars.PROD_TEST_CLASSES }}"
          sf project deploy start \
            --manifest delta/package/package.xml \
            --test-level RunSpecifiedTests \
            --runtests "${{ vars.PROD_TEST_CLASSES }}" \
            --ignore-conflicts \
            --wait 40 \
            -o prodorg

      ###################################################################
      # Deploy to PROD - RunLocalTests (if PROD_TEST_CLASSES = ALL)
      ###################################################################
      - name: Deploy Delta to PROD - RunLocalTests
        if: steps.delta.outputs.skip == 'false' && vars.PROD_TEST_CLASSES == 'ALL'
        run: |
          echo "PROD_TEST_CLASSES = ALL ‚Üí Running ALL LOCAL TESTS."
          sf project deploy start \
            --manifest delta/package/package.xml \
            --test-level RunLocalTests \
            --ignore-conflicts \
            --wait 40 \
            -o prodorg


  ###########################################################################
  # 2Ô∏è‚É£ HOTFIX DETECTION
  ###########################################################################
  detect-hotfix:
    runs-on: ubuntu-latest
    needs: deploy-production
    outputs:
      is_hotfix: ${{ steps.check.outputs.is_hotfix }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Detect Hotfix Merge
        id: check
        run: |
          echo "Detecting if merge came from hotfix/* branch‚Ä¶"

          PR_NUMBER=$(git log -1 --pretty=%B | grep -oE 'pull request #[0-9]+' | grep -oE '[0-9]+' || true)

          if [[ -z "$PR_NUMBER" ]]; then
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER"
          
          PR_DATA=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$API_URL")

          SOURCE_BRANCH=$(echo "$PR_DATA" | jq -r '.head.ref')

          if [[ "$SOURCE_BRANCH" == hotfix* ]]; then
            echo "is_hotfix=true" >> $GITHUB_OUTPUT
          else
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
          fi


  ###########################################################################
  # 3Ô∏è‚É£ AUTO BACK-SYNC ‚Äî PAT TOKEN ENABLED
  ###########################################################################
  backsync:
    runs-on: ubuntu-latest
    needs: detect-hotfix
    if: needs.detect-hotfix.outputs.is_hotfix == 'true'

    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJson(vars.SYNC_BRANCHES) }}

    steps:

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}   # üî• PAT HERE

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: 12

      - name: Sync main ‚Üí ${{ matrix.branch }}
        uses: tretuna/sync-branches@1.4.0
        with:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}   # üî• PAT HERE
          FROM_BRANCH: "main"
          TO_BRANCH: ${{ matrix.branch }}

      - name: Find PR number
        id: find_pr
        run: |
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls?state=open&base=${{ matrix.branch }}&head=${{ github.repository_owner }}:main"

          echo "Calling URL: $API_URL"

          PR=$(curl -s \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "$API_URL" | jq -r '.[0].number')

          echo "Found PR: $PR"
          echo "pr_number=$PR" >> $GITHUB_OUTPUT

      - name: Auto-merge PR (Only if checks pass)
        if: steps.find_pr.outputs.pr_number != ''
        id: automerge
        run: |
          PR=${{ steps.find_pr.outputs.pr_number }}
          echo "Evaluating PR #$PR for auto-merge..."

          # 1. Get the HEAD SHA of the PR
          SHA=$(curl -s \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR" \
            | jq -r '.head.sha')

          echo "HEAD SHA = $SHA"

          # 2. Get the status of all check suites (validations)
          CHECKS=$(curl -s \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits/$SHA/check-suites" \
            | jq -r '.check_suites[].conclusion')

          echo "Check results:"
          echo "$CHECKS"

          # 3. If any check failed ‚Üí DO NOT MERGE
          if echo "$CHECKS" | grep -q "failure"; then
            echo "‚ùå Validation failed ‚Äî NOT auto-merging"
            exit 0
          fi

          if echo "$CHECKS" | grep -q "cancelled"; then
            echo "‚ùå Validation was cancelled ‚Äî NOT auto-merging"
            exit 0
          fi

          if echo "$CHECKS" | grep -q "timed_out"; then
            echo "‚ùå Validation timed out ‚Äî NOT auto-merging"
            exit 0
          fi

          if echo "$CHECKS" | grep -q "action_required"; then
            echo "‚ùå Validation needed manual action ‚Äî NOT auto-merging"
            exit 0
          fi

          # 4. If all checks succeeded ‚Üí Merge
          if echo "$CHECKS" | grep -q "success"; then
            echo "‚úÖ All validations passed ‚Äî Auto-merging PR #$PR"
            curl -s -o merge_output.json -w "%{http_code}" \
              -X PUT \
              -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR/merge" \
              -d '{"merge_method":"merge"}'

            cat merge_output.json
            exit 0
          fi

          echo "‚ö†Ô∏è No success state detected ‚Äî NOT auto-merging"
          exit 0

