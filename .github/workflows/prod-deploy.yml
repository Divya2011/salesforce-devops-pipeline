name: Deploy to Production (Full-Proof Hotfix Back-Sync)

on:
  push:
    branches:
      - main
    paths:
      - 'force-app/**'
  workflow_dispatch:

env:
  SYNC_BRANCHES: "preprodbranch uatbranch feature"  # Branches to sync hotfixes to

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Update Salesforce CLI
        run: sf update

      - name: Authenticate to Salesforce Org (Production)
        run: |
          echo "${{ secrets.PROD_SFDX_AUTH_URL }}" > sfdx_auth_url_prod.txt
          sf org login sfdx-url -f sfdx_auth_url_prod.txt --alias prodorg --set-default
        env:
          PROD_SFDX_AUTH_URL: ${{ secrets.PROD_SFDX_AUTH_URL }}

      - name: Deploy to Production
        run: sf project deploy start --source-dir force-app --test-level RunLocalTests -o prodorg --ignore-conflicts --wait 40


  backsync-if-hotfix:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify if merge originated from hotfix branch (Full-Proof Check)
        id: check_hotfix
        run: |
          echo "üîç Checking commit metadata to determine if this is a hotfix merge..."
          
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Last commit message: $LAST_COMMIT_MSG"
          echo "---------------------------------------------------"

          # Primary Check ‚Äî Merge message pattern
          if [[ "$LAST_COMMIT_MSG" == *"Merge pull request"* && "$LAST_COMMIT_MSG" == *"from hotfix/"* ]]; then
            echo "‚úÖ Hotfix merge detected by commit message pattern."
            echo "is_hotfix=true" >> $GITHUB_ENV
          else
            echo "üî∏ Not enough evidence from commit message. Checking PR details via GitHub API..."
            
            # Extract PR number from commit message (if available)
            PR_NUMBER=$(echo "$LAST_COMMIT_MSG" | grep -oE '#[0-9]+' | tr -d '#')
            
            if [ -n "$PR_NUMBER" ]; then
              echo "Found PR number: $PR_NUMBER"
              PR_SOURCE_BRANCH=$(gh pr view $PR_NUMBER --json headRefName -q ".headRefName")
              echo "Source branch from PR: $PR_SOURCE_BRANCH"
              
              if [[ "$PR_SOURCE_BRANCH" == hotfix/* ]]; then
                echo "‚úÖ Confirmed hotfix via PR branch name."
                echo "is_hotfix=true" >> $GITHUB_ENV
              else
                echo "‚ö†Ô∏è PR source branch is not a hotfix branch ($PR_SOURCE_BRANCH)."
                echo "is_hotfix=false" >> $GITHUB_ENV
              fi
            else
              echo "‚ö†Ô∏è Could not extract PR number. Skipping back-sync."
              echo "is_hotfix=false" >> $GITHUB_ENV
            fi
          fi
          
          echo "---------------------------------------------------"
          echo "Final Hotfix Status: $is_hotfix"

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        if: env.is_hotfix == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Perform Back-Sync to Lower Branches
        if: env.is_hotfix == 'true'
        run: |
          echo "üöÄ Starting back-sync to lower branches..."
          for BRANCH in $SYNC_BRANCHES; do
            echo "-----------------------------------------"
            echo "üîÑ Attempting sync main ‚Üí $BRANCH"
            git fetch origin $BRANCH
            git checkout $BRANCH
            if git merge origin/main --no-edit; then
              git push origin $BRANCH
              echo "‚úÖ Successfully synced to $BRANCH"
            else
              echo "‚ùå Merge conflict while syncing main ‚Üí $BRANCH"
              echo "conflict_$BRANCH=true" >> $GITHUB_ENV
              git merge --abort
            fi
          done
          echo "‚úÖ Back-sync process complete."

      - name: Create Conflict PRs (if any conflicts)
        if: env.is_hotfix == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîé Checking for branches that had conflicts..."
          for BRANCH in $SYNC_BRANCHES; do
            CONFLICT_ENV="conflict_${BRANCH}"
            if [ "${!CONFLICT_ENV}" = "true" ]; then
              echo "‚ö†Ô∏è Conflict detected in $BRANCH ‚Äî creating PR..."
              git checkout -b backsync-fix-$BRANCH
              git fetch origin main
              git merge origin/main --no-commit --no-ff || true
              git commit -am "Resolve conflicts from main ‚Üí $BRANCH (hotfix back-sync)"
              git push origin backsync-fix-$BRANCH
              gh pr create --title "‚ö†Ô∏è Resolve Conflicts: main ‚Üí $BRANCH (Hotfix Back-Sync)" \
                --body "Automatic back-sync from main to $BRANCH failed due to conflicts.  
                Please review and resolve manually." \
                --base "$BRANCH" --head "backsync-fix-$BRANCH"
            fi
          done
