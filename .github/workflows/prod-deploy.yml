name: Deploy to Production (Hotfix + Auto Back-Sync)

on:
  push:
    branches:
      - main
    paths:
      - "force-app/**"
  workflow_dispatch:

# Configure this in GitHub ‚Üí Repo ‚Üí Settings ‚Üí Variables ‚Üí SYNC_BRANCHES
# Example value: preprodbranch uatbranch feature
env:
  SYNC_BRANCHES: ${{ vars.SYNC_BRANCHES || 'preprodbranch uatbranch feature' }}

jobs:

  ###########################################################################
  # 1Ô∏è‚É£ DEPLOY TO PRODUCTION
  ###########################################################################
  deploy-production:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Update Salesforce CLI
        run: sf update

      - name: Authenticate to Production
        run: |
          echo "${{ secrets.PROD_SFDX_AUTH_URL }}" > prod_auth.txt
          sf org login sfdx-url -f prod_auth.txt --alias prodorg --set-default

      - name: Deploy to Production
        run: |
          sf project deploy start \
            --source-dir force-app \
            --test-level RunLocalTests \
            --ignore-conflicts \
            --wait 40 \
            -o prodorg


  ###########################################################################
  # 2Ô∏è‚É£ DETECT HOTFIX MERGE (STRICT)
  ###########################################################################
  detect-hotfix:
    runs-on: ubuntu-latest
    needs: deploy-production
    outputs:
      is_hotfix: ${{ steps.check.outputs.is_hotfix }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Hotfix Merge (Safe)
        id: check
        run: |
          echo "Detecting if merge came from hotfix/* branch‚Ä¶"

          # 1) Get PR number safely from merge commit
          PR_NUMBER=$(git log -1 --pretty=%B | grep -oE 'pull request #[0-9]+' | grep -oE '[0-9]+' || true)

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR number found ‚Üí Not a PR merge. Marking as NOT hotfix."
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Detected PR number: $PR_NUMBER"

          # 2) Call GitHub API safely
          PR_DATA=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER || true)

          SOURCE_BRANCH=$(echo "$PR_DATA" | jq -r '.head.ref' 2>/dev/null || echo "")

          if [[ -z "$SOURCE_BRANCH" || "$SOURCE_BRANCH" == "null" ]]; then
            echo "Could not detect source branch ‚Üí Marking as NOT hotfix."
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "PR Source branch: $SOURCE_BRANCH"

          # 3) Final check
          if [[ "$SOURCE_BRANCH" == hotfix* ]]; then
            echo "üî• HOTFIX MERGE DETECTED"
            echo "is_hotfix=true" >> $GITHUB_OUTPUT
          else
            echo "‚õî Not a hotfix merge"
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
          fi

          exit 0
  ###########################################################################
  # 3Ô∏è‚É£ AUTO BACK-SYNC TO LOWER ENVIRONMENT BRANCHES
  ###########################################################################
  backsync:
    runs-on: ubuntu-latest
    needs: detect-hotfix
    if: needs.detect-hotfix.outputs.is_hotfix == 'true'

    strategy:
      fail-fast: false
      # convert "preprodbranch uatbranch feature" ‚Üí ["preprodbranch","uatbranch","feature"]
      matrix:
        branch: ${{ fromJson(vars.SYNC_BRANCHES) }}

    steps:

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup NodeJS (required by sync-branches)
        uses: actions/setup-node@v3
        with:
          node-version: 12

      - name: Sync main ‚Üí ${{ matrix.branch }}
        uses: tretuna/sync-branches@1.4.0
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM_BRANCH: "main"
          TO_BRANCH: ${{ matrix.branch }}

      - name: Debug PR mergeability (raw)
        if: steps.sync.outputs.PULL_REQUEST_NUMBER != ''
        run: |
          PR=${{ steps.sync.outputs.PULL_REQUEST_NUMBER }}

          curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR \
            > pr_raw.json

          echo "Raw PR data:"
          cat pr_raw.json


      - name: Auto-merge PR (if created)
        if: steps.sync.outputs.PULL_REQUEST_NUMBER != ''
        shell: bash
        run: |
          PR=${{ steps.sync.outputs.PULL_REQUEST_NUMBER }}
          echo "Attempting auto-merge for PR #$PR"

          ATTEMPTS=0
          MERGEABLE="null"

          while [[ "$ATTEMPTS" -lt 10 ]]; do
            echo "Checking mergeability (attempt $((ATTEMPTS+1)))‚Ä¶"
            curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls/$PR > pr.json

            MERGEABLE=$(jq -r '.mergeable' pr.json)
            echo "Mergeable state: $MERGEABLE"

            if [[ "$MERGEABLE" == "true" ]]; then
              break
            fi

            sleep 6
            ATTEMPTS=$((ATTEMPTS+1))
          done

          if [[ "$MERGEABLE" != "true" ]]; then
            echo "‚ùå PR cannot be auto-merged (not mergeable)."
            exit 0
          fi

          echo "Merging PR #$PR‚Ä¶"

          STATUS=$(curl -s -o merge_output.json -w "%{http_code}" \
            -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/merge \
            -d '{"merge_method":"merge"}')

          echo "HTTP Status: $STATUS"
          cat merge_output.json

          if [[ "$STATUS" == "200" ]]; then
            echo "‚úÖ PR #$PR successfully merged."
          else
            echo "‚ùå Failed to merge PR #$PR"
            exit 1
          fi
