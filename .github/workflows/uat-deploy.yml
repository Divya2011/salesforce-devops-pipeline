name: Deploy to UAT

on:
  push:
    branches:
      - uatbranch # Or the branch you merge to for UAT deployments
    paths:
      - 'force-app/**'
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate to Salesforce Org (UAT)
        run: |
          echo "${{ secrets.UAT_SFDX_AUTH_URL }}" > sfdx_auth_url_uat.txt
          sf org login sfdx-url -f sfdx_auth_url_uat.txt --alias uatorg --set-default
        env:
          UAT_SFDX_AUTH_URL: ${{ secrets.UAT_SFDX_AUTH_URL }} # Stored as a GitHub secret

      - name: Generate Package.xml (if needed)
        run: sf project generate packagexml --from-source --output-dir manifest

      - name: Deploy to UAT
        run: sf project deploy start --metadata-dir manifest --test-level RunLocalTests -o uatorg --ignore-conflicts --wait 40
