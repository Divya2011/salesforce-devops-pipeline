name: Deploy to PreProd

on:
  push:
    branches:
      - preprodbranch   # When updates are merged into PreProd
    paths:
      - 'force-app/**'

  workflow_dispatch:  # Allow running manually

jobs:
  deploy-PreProd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # required for delta calculation

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Install SFDX Git Delta
        run: echo y | sf plugins install sfdx-git-delta

      - name: Authenticate to Salesforce Org (PreProd)
        run: |
          echo "${{ secrets.PREPROD_SFDX_AUTH_URL }}" > sfdx_auth_url_preprod.txt
          sf org login sfdx-url -f sfdx_auth_url_preprod.txt --alias preprodorg --set-default
        env:
          PREPROD_SFDX_AUTH_URL: ${{ secrets.PREPROD_SFDX_AUTH_URL }}


      ###################################################################
      # Generate Delta Package
      ###################################################################
      - name: Generate Delta
        id: delta
        run: |
          mkdir -p delta

          sf sgd:source:delta \
            --to "$GITHUB_SHA" \
            --from "HEAD^" \
            --output-dir delta \
            --generate-delta \
            --source force-app/

          echo "Generated package.xml:"
          cat delta/package/package.xml || echo "NO DELTA FOUND"

          if [ ! -s delta/package/package.xml ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi


      ###################################################################
      # Deploy DELTA (NO TESTS)
      ###################################################################
      - name: Deploy Delta to PreProd (No Tests)
        if: steps.delta.outputs.skip == 'false'
        run: |
          echo "Deploying delta to PreProd with NO test execution..."

          sf project deploy start \
            --manifest delta/package/package.xml \
            --test-level NoTestRun \
            --ignore-conflicts \
            --wait 40 \
            -o preprodorg


      ###################################################################
      # Skip if no delta found
      ###################################################################
      - name: No Delta Found — Skipping Deployment
        if: steps.delta.outputs.skip == 'true'
        run: echo "No metadata differences detected — skipping deployment."
