name: PR Validate (UAT)

on:
  pull_request:
    branches: [uatBranchNew]   # Trigger when PR points to UAT branch

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required for delta generation

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Install SFDX Git Delta
        run: echo y | sf plugins install sfdx-git-delta

      - name: Authenticate to UAT Org
        run: |
          echo "${{ secrets.UAT_SFDX_AUTH_URL }}" > sfdx_auth.txt
          sf org login sfdx-url -f sfdx_auth.txt --alias UAT

      ###################################################################
      # Generate ONLY delta changes
      ###################################################################
      - name: Generate Delta Package
        id: delta
        run: |
          mkdir -p delta

          # compare PR head vs base commits
          sf sgd:source:delta \
            --to "${{ github.event.pull_request.head.sha }}" \
            --from "${{ github.event.pull_request.base.sha }}" \
            --output-dir delta \
            --generate-delta \
            --source force-app/

          echo "Delta Package XML:"
          cat delta/package/package.xml || echo "NO DELTA FOUND"

          # check if delta XML file exists & not empty
          if [ ! -s delta/package/package.xml ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi


      ###################################################################
      # Validate Delta (No Test Execution)
      ###################################################################
      - name: Validate Delta (NoTests)
        if: steps.delta.outputs.skip == 'false'
        run: |
          echo "Validating delta metadata with NO tests"

          sf project deploy start \
            --manifest delta/package/package.xml \
            --test-level NoTestRun \
            --dry-run \
            --ignore-conflicts \
            --wait 20 \
            -o UAT

      ###################################################################
      # Skip when no delta found
      ###################################################################
      - name: No Delta Found — Skipping Validation
        if: steps.delta.outputs.skip == 'true'
        run: echo "No metadata differences detected — skipping validation"
